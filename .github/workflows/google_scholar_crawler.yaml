name: Get Citation Data   # å·¥ä½œæµåç§°ï¼Œå¯è‡ªè¡Œè°ƒæ•´

###############################################################################
# è§¦å‘æ–¹å¼ï¼š
#   â€¢ workflow_dispatch     ğŸ‘‰ å…è®¸åœ¨ Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡» â€œRun workflowâ€
#   â€¢ schedule              ğŸ‘‰ æ¯å‘¨ UTC 8:00ï¼ˆåŒ—äº¬æ—¶é—´ 16:00ï¼‰è‡ªåŠ¨è¿è¡Œä¸€æ¬¡
###############################################################################
on:
  workflow_dispatch:
  schedule:
    # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ† (0-59)
    # â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€ æ—¶ (0-23)   8 = UTC 08:00
    # â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€ æ—¥ (1-31)
    # â”‚ â”‚ â”‚ â”Œâ”€â”€â”€ æœˆ (1-12)
    # â”‚ â”‚ â”‚ â”‚ â”Œâ”€ å‘¨ (0-6) 0 = Sunday
    # â”‚ â”‚ â”‚ â”‚ â”‚
    - cron: '0 8 * * 0'   # ğŸ‘‰ æ¯å‘¨æ—¥ 08:00 UTC è§¦å‘ï¼ˆå³åŒ—äº¬æ—¶é—´å‘¨æ—¥ 16:00ï¼‰

###############################################################################
jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout ä»£ç ï¼ˆä¸ä¿ç•™ GitHub é»˜è®¤åªè¯» tokenï¼‰
    - uses: actions/checkout@v3
      with:
        persist-credentials: false

    # 2) å®‰è£… Python & ä¾èµ–
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y python3-setuptools
        pip3 install -r google_scholar_crawler/requirements.txt

    # 3) è¿è¡Œçˆ¬è™«è„šæœ¬ï¼Œç”Ÿæˆ JSON æ•°æ®åˆ° google_scholar_crawler/results
    - name: Run Google Scholar crawler
      env:
        GOOGLE_SCHOLAR_ID: ${{ secrets.GOOGLE_SCHOLAR_ID }}
      run: |
        cd google_scholar_crawler
        python3 main.py

    # 4) æäº¤ JSON åˆ° google-scholar-stats åˆ†æ”¯
    - name: Commit & push citation data
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # GitHub è‡ªåŠ¨æ³¨å…¥çš„å†™å…¥ token
      run: |
        cd google_scholar_crawler/results

        # è®¾ç½®æäº¤èº«ä»½
        git init
        git config user.name  "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"

        # æ·»åŠ å¹¶æäº¤
        git add *.json
        git commit -m "ğŸ“š update citation data" || echo "no changes"

        # æ¨é€åˆ° google-scholar-stats åˆ†æ”¯
        git branch -M google-scholar-stats
        git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
        git push -u origin google-scholar-stats --force
